{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load i18n %}

{% block help %}
  {% include 'location/inc/help.html' %}
{% endblock %}


{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>

<script>
  $(document).ready(function() {
    var mymap = L.map('mapid').setView(["{{ location.lat|stringformat:'f' }}", "{{ location.lon|stringformat:'f' }}"], 10);

    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
      maxZoom: 18,
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
        '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
        'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
      id: 'mapbox/streets-v11',
      tileSize: 512,
      zoomOffset: -1
    }).addTo(mymap);
    var marker = L.marker(["{{ location.lat|stringformat:'f' }}", "{{ location.lon|stringformat:'f' }}"]).addTo(mymap);
  });
</script>
{% endblock %}


{% block content %}
<div class="container-fluid mb-3">
  <div class="row">
    <div class="col d-flex justify-content-end"><a class="btn btn-link text-info" href="{% url 'location_list' %}">{{ symbols.back|safe }}&nbsp;{% trans 'back' %}</a></div>
  </div>
</div>

<div class="container-fluid border">
  <div class="row">
    <div class="col-12 p-0">
      <div id="mapid" style="height:400px;z-index:0;"></div>
    </div>
  </div>
</div>

<hr class="my-5">

<div class="container-fluid border">
  <div class="row">
    <div class="col-8">
        <h3>{% trans 'offerings'|title %} {% trans 'at' %} {% trans 'location' %} {{ location.title }}</h3>
    </div>
    <div class="col-4 d-md-flex justify-content-end">
        {% if user == request.user %}<a class="btn p-0 text-info" href="{% url 'listing_create' 'push' %}"><i class="fas fa-plus"></i> {% trans 'offer' %}</a>{% endif %}
    </div>
  </div>
  <div class="row">
    <div class="col-12 col-sm-4 col-md-2 order-4 order-sm-1">
      <b>{% trans 'category'|title %}</b>
    </div>
    <div class="col-12 col-sm-8 col-md-5 order-1 order-sm-2">
      <b>{% trans 'title'|title %}</b>
    </div>
    <div class="col-12 col-sm-4 col-md-2 order-2 order-sm-3">
      <b>{% trans 'quantity'|title %}</b>
    </div>
    <div class="col-12 col-sm-8 col-md-3 order-3 order-sm-4 d-flex justify-content-end">
      <b>{% trans 'modified'|title %}</b>
    </div>
  </div>
  {% for listing in location.pushs %}
  <div class="row border-top">
    <div class="col-12 col-sm-4 col-md-2 order-4 order-sm-1">
      {% with category=listing.category %}{% include 'category/inc/link.html' %}{% endwith %}
    </div>
    <div class="col-12 col-sm-8 col-md-5 order-1 order-sm-2">
      {% include 'listing/inc/link.html' %} {{ listing.title }}
    </div>
    <div class="col-12 col-sm-4 col-md-2 order-2 order-sm-3">
      {{ listing.quantity }}{{ listing.unit.short }}
    </div>
    <div class="col-12 col-sm-8 col-md-3 order-3 order-sm-4 d-flex justify-content-end" title="{{ listing.modified }}">
      {{ listing.modified|naturaltime }}
    </div>
  </div>
  {% endfor %}
</div>
<hr class="my-5">
<div class="container-fluid border">
  <div class="row">
    <div class="col-8">
      <h3 class="row">{% trans 'requests'|title %} {% trans 'at' %} {% trans 'location' %} {{ location.title }}</h3>
    </div>
    <div class="col-4 d-md-flex justify-content-end">
        {% if user == request.user %}<a class="btn p-0 text-info" href="{% url 'listing_create' 'pull' %}"><i class="fas fa-plus"></i> {% trans 'seek' %}</a>{% endif %}
    </div>
  </div>
  <div class="row">
    <div class="col-12 col-sm-4 col-md-2 order-4 order-sm-1">
      <b>{% trans 'category'|title %}</b>
    </div>
    <div class="col-12 col-sm-8 col-md-5 order-1 order-sm-2">
      <b>{% trans 'title'|title %}</b>
    </div>
    <div class="col-12 col-sm-4 col-md-2 order-2 order-sm-3">
      <b>{% trans 'quantity'|title %}</b>
    </div>
    <div class="col-12 col-sm-8 col-md-3 order-3 order-sm-4 d-md-flex justify-content-end">
      <b>{% trans 'modified'|title %}</b>
    </div>
  </div>
  {% for listing in user.pulls %}
  <div class="row border-top">
    <div class="col-12 col-sm-4 col-md-2 order-4 order-sm-1">
      {% with category=listing.category %}{% include 'category/inc/link.html' %}{% endwith %}
    </div>
    <div class="col-12 col-sm-8 col-md-5 order-1 order-sm-2">
      {% include 'listing/inc/link.html' %} {{ listing.title }}
    </div>
    <div class="col-12 col-sm-4 col-md-2 order-2 order-sm-3">
      {{ listing.quantity }}{{ listing.unit.short }}
    </div>
    <div class="col-12 col-sm-8 col-md-3 order-3 order-sm-4 d-md-flex justify-content-end" title="{{ listing.modified }}">
      {{ listing.modified|naturaltime }}
    </div>
  </div>
  {% endfor %}
</div>

<hr class="my-5">
<div class="container-fluid border">
  <div class="row">
    <div class="col-8">
        <h3>{% trans 'deals'|title %} {% trans 'at' %} {% trans 'location' %} {{ location.title }}</h3>
    </div>
    <div class="col-4 d-md-flex justify-content-end">
      {% if request.user == location.user %}
        <a class="btn p-0 text-info" href="{% url 'deal_create' %}"><i class="fas fa-plus"></i> {% trans 'deal' %}</a>
      {% endif %}
    </div>
  </div>
  <div class="row">
    <div class="col"><b>{% trans 'user'|title %}</b></div>
    <div class="col"><b>{% trans 'offers' %}</b></div>
    <div class="col"><b>{% trans 'takes' %}</b></div>
    <div class="col"><b>{% trans 'partner'|title %}</b></div>
    <div class="col"><b>{% trans 'status' %}</b></div>
    <div class="col"></div>
  </div>
  {% for deal in location.deals %}
  <div class="row border-top">
    <div class="col">{% with user=deal.user %}{% include 'user/inc/link.html' %}{% endwith %}</div>
    <div class="col">{% for listing in deal.pushs %}{% include 'listing/inc/link.html' %} {% endfor %}</div>
    <div class="col">{% for listing in deal.pulls %}{% include 'listing/inc/link.html' %} {% endfor %}</div>
    <div class="col">{% with user=deal.partner %}{% include 'user/inc/link.html' %}{% endwith %}</div>
    <div class="col d-flex justify-content-end">{% include 'deal/inc/status.html' %}</div>
    <div class="col d-flex justify-content-end"><a class="text-info btn" href="{% url 'deal_detail' deal.pk %}"><i class="fas fa-search"></i></a></div>
  </div>
  {% endfor %}
</div>


<hr class="my-5">


<div class="container-fluid border">
  <div class="row">
    <div class="col-8">
        <h3>{% trans 'markets'|title %} {% trans 'at' %} {% trans 'location' %} {{ location.title }}</h3>
    </div>
    <div class="col-4 d-md-flex justify-content-end">
        <a class="btn btn-link p-0 text-info" href="{% url 'market_create' %}"><i class="fas fa-plus"></i> {% trans 'market' %}</a>
    </div>
  </div>
  <div class="row">
    <div class="col"><b>{% trans 'name'|title %}</b></div>
    <div class="col"><b>{% trans 'member'|title %}</b></div>
    <div class="col"><b></b></div>
  </div>
  {% for market in location.markets %}
    <div class="row border-top">
      <div class="col">{% include 'market/inc/link.html' %}</div>
      <div class="col">{% for user in market.users.all %}{% include 'user/inc/link.html' %}{% endfor %}</div>
      <div class="col d-flex justify-content-end">
        {% if request.user in market.users.all %}
        <a class="btn btn-link" href="{% url 'market_delete' market.pk %}" title="{% trans 'delete' %}">{{ symbols.delete|safe }}</a>
        <a class="btn btn-link" href="{% url 'market_update' market.pk %}" title="{% trans 'update' %}">{{ symbols.update|safe }}</a>
        {% endif %}
        <a class="btn btn-link" href="{% url 'market_detail' market.pk %}" title="{% trans 'details' %}">{{ symbols.detail|safe }}</a>
      </div>
    </div>
  {% endfor %}
</div>
{% endblock %}
